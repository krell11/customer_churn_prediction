# Customer Churn Prediction: Survival Analysis Approach

Данный проект посвящен прогнозированию оттока банковских клиентов. Для решения задачи используется подход анализа выживаемости Survival Analysis.

## Цель: Разработать модель машинного обучения на базе методов Survival Analysis (Анализ выживаемости), которая позволит ранжировать клиентов по риску оттока (Hazard Score). Это позволит бизнесу приоритезировать маркетинговые активности, фокусируясь на клиентах с наивысшим риском ухода в ближайшее время.

## Структура данных
Входные данные: 
  * Данные о клиентах 
  * История транзакций (суммы, MCC-коды, валюты).
  * Временные метки формирования отчетов.

Выходные данные:
  * Оценка риска (Hazard Score) для каждого клиента




Данные были взяты с DataFusion2024 с кейса по оттоку клиентов, для удобвства данные выложены на google drive, их можно загрузить по [ссылке](https://drive.google.com/drive/folders/1o-dVpimXTZPMZ5uCTFlFplRL5tQYZ-qM?usp=sharin)


## Предобработка, анализ и постановка задачи
В ходе разведочного анализа (EDA) была выявлена особенность данных: наличие временного разрыва между последними транзакциями клиентов и датами формирования отчетов. Использование скользящих окон (агрегации за последние 30/60/90 дней) показало низкую информативность из-за разреженности событий в этих периодах, поэтому было принято решение строить другие фичи, а именно:
* recency - Количество дней с момента последней транзакции клиента до даты формирования отчет, чем больше клиент не совершает покупки, тем больше вероятность, что он уже не вернется.
* total_cnt - Общее количество транзакций клиента за весь наблюдаемый период, так отображаем вовлеченность клиента, чем больше пользуется, тем более лояльный.
* total_sum - Сумма всех транзакций клиента, оцениваем насколько ценный клиент для нас (Применено логарифмирование для сглаживания выбросов).
* avg_check - Средний чек, отношение общей суммы трат к количеству транзакций.
* std_check - Стандартное отклонение сумм транзакций.
* unique_mcc - Разнообразие категорий.
* unique_currency - Валютная активность.
<img width="1984" height="484" alt="image" src="https://github.com/user-attachments/assets/61905621-a3cd-42a0-851b-f013c362bf0f" />

### При работе с данными было выявлено несколько особенностей:
* Тяжелые хвосты у признаков активности и денежных признаков, Большинство клиентов совершают мало транзакций, но есть клиенты с аномально высокими показателями, поэтому было применено логарифмирование к данным, чтобы нормализовать данные.
* Аномалия в Recency, минимальное значение признака recency составляет 101 день, это подтверждает гипотезу о временном разрыве в данных: в выборке отсутствуют данные о транзакциях за последние 3 месяца перед датой отчета
### Баланс классов:
Анализ целевой переменной target показал дисбаланс классов:
* Активные клиенты: ~ 91.5%
* Отток: ~ 8.5%
### Корреляционный анализ
Сконструированные фичи проверялись на линейную зависимость, матрица корреляций показала ожидаемую сильную линейную зависимость между: 
 - total count и uniquie_mcc
 - total sum и total count
Это не должно стать проблемой для бустинга
## Оценка качества
В качестве метрики качества ранжирования будет использоваться C-index, реализация взята из sksurv (sksurv.metrics.concordance_index_censored).
Стандартные метрики регрессии (MSE, MAE) или классификации (Accuracy, F1) неприменимы напрямую к задачам выживания, так как они не умеют работать с цензурированными данными (клиентами, которые "еще не ушли"), поэтому мы формализуем постановку задачи до такого вида:
выбрав функцию потерь Cox Partial Likelihood в библиотеке CatBoost, мы неявно принимаем гипотезу о пропорциональных рисках. В рамках этой гипотезы функция риска имеет вид $h(t | x) = h_0(t) \cdot \exp(f(x))$, а алгоритм градиентного бустинга ищет оптимальную функцию $f(x)$ (log-hazard), которая минимизирует ошибки ранжирования.
Впоследствии будем использовать это при решении задачи с помощью CatBoost.
## Реализация модели
Для начала построим самый простой анализ кривой Каплана-Майера, который показывает, что отток клиентов происходит относительно равномерно. К концу наблюдаемого периода (90 дней) кумулятивная доля ушедших клиентов достигает ~10%. Резкое падение вероятности выживания в последние дни периода может быть связано с особенностями цензурирования данных
<img width="865" height="556" alt="image" src="https://github.com/user-attachments/assets/e0f0625a-2cee-4e42-90b5-fb3c49807512" />
В качестве базовой модели для персонализированного прогноза был использован классический метод Cox Proportional Hazards из библиотеки lifelines
На выходе получили значение c_index'a np.float64(0.70388980265683) 
Далее отойдем от примитивной постановки к финальному решению:
Для построения финального решения выбран алгоритм градиентного бустинга CatBoostRegressor, который поддерживает функцию потерь для задач выживания:
При первом запуске получилось добиться метрики C-index np.float64(0.7476571803442139)
При построении пайплайна подбора гиперпараметров не получилось кардинально улучшить метрику, поэтому было принято решение остановиться на таком решении.
## Обсуждение и выводы
### Краткое саммари по решению
Решение допустимо к применению, но не смотря на достаточно высокий C-index мы получаем результат не в виде легко интерпретируемой вероятности ухода пользователя, а в виде риска, который менее очевиден для интепретации, также модель будет плохо учитывать краткосрочное изменение
### Возможные улучшения
- Устранение разрыва данных, чтобы чтобы признаки рассчитывались на дату сегодня - 1, а не сегодня - 100 дней, как сделано в решении.
- Построить модель поверх Hazard Score, которая будет переводить риск в ожидаемое время жизни.



